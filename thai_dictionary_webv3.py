import streamlit as st
import json
import os
import hashlib
from deep_translator import GoogleTranslator
import wikipedia
from gtts import gTTS
import base64

# --- Config ---
WIKI_LANG = 'th'
wikipedia.set_lang(WIKI_LANG)
MEMORY_FILE = 'thai_dict_memory.json'

# --- Functions ---

def load_memory():
    if os.path.exists(MEMORY_FILE):
        with open(MEMORY_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    return {}

def save_memory(mem):
    with open(MEMORY_FILE, 'w', encoding='utf-8') as f:
        json.dump(mem, f, ensure_ascii=False, indent=2)

def hash_password(pwd):
    return hashlib.sha256(pwd.encode()).hexdigest()

def translate_word(word, direction="th_to_en"):
    try:
        return GoogleTranslator(
            source='th' if direction == 'th_to_en' else 'en',
            target='en' if direction == 'th_to_en' else 'th'
        ).translate(word)
    except:
        return "(‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡πÑ‡∏î‡πâ)"

def wikipedia_summary(word):
    try:
        return wikipedia.summary(word, sentences=2)
    except:
        return "(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Wikipedia)"

def google_image(word):
    return f"https://www.google.com/search?tbm=isch&q={word}"

def text_to_speech(text, lang='th', slow=False):
    try:
        tts = gTTS(text=text, lang=lang, slow=slow)
        tts.save("temp.mp3")
        with open("temp.mp3", "rb") as f:
            audio_bytes = f.read()
        b64 = base64.b64encode(audio_bytes).decode()
        return f'<audio controls><source src="data:audio/mp3;base64,{b64}" type="audio/mp3"></audio>'
    except:
        return None

# --- Initialization ---

if 'users' not in st.session_state:
    # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô user ‡πÄ‡∏î‡∏¥‡∏°
    st.session_state.users = {
        "admin": {"password": hash_password("1234")}
    }

if 'logged_in' not in st.session_state:
    st.session_state.logged_in = False

if 'user' not in st.session_state:
    st.session_state.user = ""

if 'memory' not in st.session_state:
    st.session_state.memory = load_memory()

# --- Login Page ---

def login_page():
    st.markdown("""
    <style>
    .login-container {
        max-width: 400px;
        margin: 80px auto;
        padding: 30px;
        background: #273c75;
        border-radius: 15px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        color: white;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .login-container h2 {
        text-align: center;
        margin-bottom: 25px;
        color: #00a8ff;
        text-shadow: 0 0 8px #00a8ff;
    }
    .login-container input, .login-container button {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border-radius: 10px;
        border: none;
        font-size: 1rem;
    }
    .login-container input {
        background: #192a56;
        color: white;
    }
    .login-container button {
        background: #00a8ff;
        color: #192a56;
        font-weight: 700;
        cursor: pointer;
        transition: background 0.3s ease;
    }
    .login-container button:hover {
        background: #0097e6;
        color: white;
    }
    </style>
    """, unsafe_allow_html=True)
    st.markdown('<div class="login-container">', unsafe_allow_html=True)
    st.markdown("<h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏° AI</h2>", unsafe_allow_html=True)

    username = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", key="login_user")
    password = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", type="password", key="login_pass")

    col1, col2 = st.columns(2)
    with col1:
        if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"):
            if username in st.session_state.users and st.session_state.users[username]["password"] == hash_password(password):
                st.session_state.logged_in = True
                st.session_state.user = username
                st.experimental_rerun()
            else:
                st.error("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")
    with col2:
        if st.button("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å"):
            if username and password:
                if username in st.session_state.users:
                    st.error("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß")
                else:
                    st.session_state.users[username] = {"password": hash_password(password)}
                    st.success("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö")
            else:
                st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô")

    st.markdown('</div>', unsafe_allow_html=True)
    st.stop()

# --- Logout Function ---

def logout():
    st.session_state.logged_in = False
    st.session_state.user = ""
    st.experimental_rerun()

# --- Main App ---

if not st.session_state.logged_in:
    login_page()

st.sidebar.markdown(f"üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: **{st.session_state.user}**")
if st.sidebar.button("üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö"):
    logout()

st.title("üìò ‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏° AI")

query = st.text_input("üîç ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:", key="query").strip().lower()
language = st.radio("üåè ‡∏†‡∏≤‡∏©‡∏≤:", ["‡πÑ‡∏ó‡∏¢ ‚Üí ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©", "‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‚Üí ‡πÑ‡∏ó‡∏¢"])
new_desc = st.text_input("üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:", key="new_desc")

def save_description():
    q = st.session_state.query
    desc = st.session_state.new_desc.strip()
    user = st.session_state.user
    if not q:
        st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤")
        return
    if not desc:
        st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢")
        return
    if q not in st.session_state.memory:
        st.session_state.memory[q] = []
    st.session_state.memory[q].append({"name": user, "desc": desc})
    save_memory(st.session_state.memory)
    st.success("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")
    st.session_state.new_desc = ""

if st.button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", on_click=save_description):
    pass

if query:
    direction = "th_to_en" if language == "‡πÑ‡∏ó‡∏¢ ‚Üí ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©" else "en_to_th"
    lang_code = "th" if direction == "th_to_en" else "en"

    with st.expander("üîÅ ‡∏ú‡∏•‡∏à‡∏≤‡∏Å Google Translate", expanded=True):
        translated = translate_word(query, direction)
        st.write(f"**{query}** ‚û°Ô∏è **{translated}**")
        back_translated = translate_word(translated, "en_to_th" if direction == "th_to_en" else "th_to_en")
        st.write(f"üîÑ ‡πÅ‡∏õ‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö: **{translated}** ‚û°Ô∏è **{back_translated}**")
        audio = text_to_speech(query, lang=lang_code)
        if audio:
            st.markdown("üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡πà‡∏≤‡∏ô:")
            st.markdown(audio, unsafe_allow_html=True)

    with st.expander("üìö ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏≤‡∏Å Wikipedia"):
        summary = wikipedia_summary(query)
        st.write(summary)
        audio_summary = text_to_speech(summary, lang=lang_code)
        if audio_summary:
            st.markdown("üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢:")
            st.markdown(audio_summary, unsafe_allow_html=True)

    with st.expander("üñºÔ∏è ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Google"):
        st.markdown(f"[üîó ‡∏î‡∏π‡∏†‡∏≤‡∏û]({google_image(query)})")

    # ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
    if query in st.session_state.memory:
        st.markdown("---")
        st.subheader("üìã ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏µ‡πâ")
        for i, item in enumerate(st.session_state.memory[query]):
            st.markdown(f"{i+1}. **{item['name']}**: {item['desc']}")
            if item['name'] == st.session_state.user:
                btn_key = f"del_{query}_{i}"
                if st.button(f"üóëÔ∏è ‡∏•‡∏ö ({i+1})", key=btn_key):
                    st.session_state.memory[query].pop(i)
                    if not st.session_state.memory[query]:
                        del st.session_state.memory[query]
                    save_memory(st.session_state.memory)
                    st.experimental_rerun()

st.markdown("---")
st.caption("üë®‚Äçüíª ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥: [FOxDoryu]")
st.caption("ü§ñ AI ‡πÇ‡∏î‡∏¢ ChatGPT (OpenAI)")
